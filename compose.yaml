services:
  meshing-around:
    # Use host network to reach mesh nodes on LAN
    network_mode: host
    #ports:
      #- 8420:8420
    #devices:
      #- /dev/ttyUSB0:/dev/tty #update your config.ini to /dev/tty
      #- /dev/ttyACM0:/dev/tty #if using serial select proper port
    volumes:
      - .:/app:rw
    build: .
    image: meshing-around:local
    container_name: meshing-around
    restart: unless-stopped
    environment:
      - TZ=America/Denver
      - OLLAMA_API_URL=http://localhost:11434
    #extra_hosts:
      #- "host.docker.internal:host-gateway"
    #user: "1000:1000"
    #user: "10999:10999"
    #networks:
      #- meshing-around-network

  webgui:
    build:
      context: ./webgui
      dockerfile: Dockerfile
    image: meshbot-webgui:local
    container_name: meshbot-webgui
    restart: unless-stopped
    ports:
      - "8085:8000"
    volumes:
      - ./config.ini:/opt/meshing-around/config.ini:rw
      - ./data:/app/data:rw
      - ./logs:/opt/meshing-around/logs:ro
      - ./webgui/backups:/opt/meshing-around/webgui/backups:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=America/Denver
      - CONFIG_PATH=/opt/meshing-around/config.ini
      - BACKUP_DIR=/opt/meshing-around/webgui/backups
      - SERVICE_NAME=meshing-around
      - MESHBOT_LOG_PATH=/opt/meshing-around/logs/meshbot.log
      - LOG_ARCHIVE_DIR=/app/log_archives
      - PACKET_BUFFER_PATH=/app/data/packets.json
      - BBS_PEERS_PATH=/app/data/bbs_peers.json
      - LEADERBOARD_EXPORT_PATH=/app/data/leaderboard_webgui.json
      - NODEDB_PATH=/app/data/nodedb.json
      # Set to enable API key auth (leave empty to disable)
      - WEBGUI_API_KEY=${WEBGUI_API_KEY:-}
      # Set for cross-origin access (comma-separated, leave empty for same-origin only)
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      # OIDC Authentication (optional â€” works with any OIDC provider)
      # Set all three to enable: discovery URL, client ID, client secret
      - OIDC_DISCOVERY_URL=${OIDC_DISCOVERY_URL:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_SCOPES=${OIDC_SCOPES:-openid profile email}
      - OIDC_SESSION_SECRET=${OIDC_SESSION_SECRET:-}
      - OIDC_SESSION_MAX_AGE=${OIDC_SESSION_MAX_AGE:-28800}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI:-}
      - OIDC_COOKIE_SECURE=${OIDC_COOKIE_SECURE:-true}
    depends_on:
      - meshing-around

  test-bot:
    build: .
    image: meshing-around:local
    container_name: test-bot
    command: ["/bin/bash", "-c", "python3 modules/test_bot.py | tee /tmp/test_tmp.txt; if grep -E 'failures=|errors=' /tmp/test_tmp.txt; then cp /tmp/test_tmp.txt /app/test_results.txt; fi"]
    volumes:
      - .:/app:rw
    networks:
      - meshing-around-network
    stdin_open: true

  debug-console:
    build: .
    image: meshing-around:local
    container_name: debug-console
    command: ["/bin/bash"]
    stdin_open: true
    tty: true
    volumes:
      - .:/app:rw
    networks:
      - meshing-around-network

  meshtasticd:
    ports:
      - 4403:4403
      - 443:443
    volumes:
      - ./script/docker:/etc/meshtasticd:rw
    restart: unless-stopped
    container_name: meshtasticd
    image: meshtastic/meshtasticd:daily-debian
    networks:
      - meshing-around-network

  ollama:
    ports: 
      - 11434:11434
    container_name: ollama
    image: ollama/ollama:latest
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - meshing-around-network

networks:
  meshing-around-network:
    external: true
